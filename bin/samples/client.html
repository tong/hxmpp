<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="author" content="disktree.net" />
<title>HXMPP-JS</title>
<script type="text/javascript" src="../hxmpp.js"/></script>
<script type="text/javascript" src="../swfobject.js"/></script>
</head>
<body>

<form>
	<input type="text" id="jid" value="tong@disktree"></input>
	<label for="jid">JID</label><br>
	<input type="password" id="pass" value="test"></input>
	<label for="pass">PASSWORD</label><br>
	<input type="button" id="login" value="LOGIN &raquo" onclick="openStream()"></input>
</form>

<div id="f9bridge">NO FLASHPLAYER DETECTED</div>
<div id="haxe:trace"></div>

<script type="text/javascript">swfobject.embedSWF("../f9_socketbridge.swf","f9bridge","0","0","9.0.0");</script>
<script type="text/javascript">

console.log("HXMPP");

jabber.Lib.initSocketBridge();
jabber.XMPPDebug.redirectTraces();

var stream;


function streamStatusChangeHandler(stream) {
	switch( stream.status ) {
	case jabber.StreamStatus.open :
		var auth = new jabber.client.NonSASLAuthentication(stream);
		auth.onSuccess = function() {
			var roster = new jabber.client.Roster(stream);
			roster.onLoad = function(r) {
				console.info("Roster loaded");
			}
			console.info("Authenticated");
			roster.load();
		};
		auth.onFailed = function(s) { printHtml("jabberstatus","Authentication failed"); };
		auth.authenticate(document.getElementById("pass").value,"norc");
		break;
	case jabber.StreamStatus.closed :
		//..
		break;
	}
	console.info("Stream status: %s",stream.status);
}

function openStream() {
	var jidstr=document.getElementById("jid").value;
	if(!jabber.JIDUtil.isValid(jidstr)) {
		console.warn("Invalid JID ("+jidstr+")");
		return;
	}
	var jid = new jabber.JID(jidstr);
	var cnx = new jabber.SocketConnection(jid.host,jabber.client.Stream.defaultPort);
	stream = new jabber.client.Stream(jid,cnx);
	stream.onOpen = streamStatusChangeHandler;
	stream.onClose = streamStatusChangeHandler;
	stream.onError = function(e){
		console.error("%o",e);
	};
	stream.open();
}

</script>

</body>
</html>
